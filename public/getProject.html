<!DOCTYPE html>
<html lang="en">
    <head>
        <link rel="stylesheet" href="style.css" type="text/css" />
    </head>
    <body class="body">
        <div class="topnav">
            <a href="#home">Not idea</a>
            <a href="#news">Just learning</a>
        </div>
        <h3 class="center">Github API Data</h3>
        <h3 class="center">This is a website to fetch users data</h3>
        <div class="container my-5">
            <button class="btn btn-primary my-3" id="btnUser">Get User</button>
            <button class="btn btn-warning" id="getProject">Get Project</button>
        </div>
        <div class="container my-5">
            <div class="card mt-3">
                <div class="card-header">Username</div>
                <div class="card-body">
                    <p><span id="username"></span></p>
                </div>
            </div>
            <div class="card mt-3">
                <div class="card-header">Title name</div>
                <div class="card-body">
                    <p><span id="title"></span></p>
                </div>
            </div>
            <div class="card mt-3">
                <div class="card-header">Description</div>
                <div class="card-body">
                    <p><span id="description">okaay</span></p>
                </div>
            </div>
            <div class="card mt-3">
                <div class="card-header">Commits</div>
                <div class="card-body">
                    <p><span id="commits"></span></p>
                </div>
            </div>
            <div class="card mt-3">
                <div class="card-header">Contributors</div>
                <div class="card-body">
                    <ul>
                        <p><span id="contributors"></span></p>
                    </ul>
                </div>
            </div>
        </div>
        <script>
            btnUser.onclick = fetchProjectInfo('me945', 'IOS_Calculator')

            async function fetchProjectInfo(username, projectTitle) {
                let user = {}
                user.contributors = []
                let login = []
                let promises = []
                var luck = username
                return Promise.all([
                    // promise 1
                    fetch(
                        `https://api.github.com/repos/${username}/${projectTitle}`,
                        {
                            // headers: {
                            //     Authorization:
                            //         'token ' + process.env.GITHUB_API_TOKEN,
                            // },
                        }
                    )
                        .then((res) => {
                            if (res.status === 200) {
                                return res.json()
                            } else {
                                return 'did not find the project'
                            }
                        })
                        .then((json) => {
                            //console.log(json)
                            user.title = json.name
                            user.description = json.description
                        })
                        .catch((error) => {
                            console.log(error)
                        }),
                    // promise 2
                    fetch(
                        `https://api.github.com/repos/${username}/${projectTitle}/commits?per_page=1`,
                        {
                            // headers: {
                            //     Authorization:
                            //         'token ' + process.env.GITHUB_API_TOKEN,
                            // },
                        }
                    )
                        .then((res) => {
                            if (res.status === 200) {
                                return res.headers
                            } else {
                                return 'did not find commits'
                            }
                        })
                        .then((object) => {
                            const link = object.get('link')
                            const links = link.split(', ')
                            const lastLink = links[links.length - 1]
                            const pageNumberString = lastLink.slice(
                                lastLink.indexOf('&page=') + 6,
                                lastLink.indexOf('>')
                            )
                            const pageNumber = Number(pageNumberString)
                            user.commits = pageNumber
                        })
                        .catch((error) => {
                            console.log(error)
                        }),
                    // promise 3
                    fetch(
                        `https://api.github.com/repos/${username}/${projectTitle}/contributors`,
                        {
                            // headers: {
                            //     Authorization:
                            //         'token ' + process.env.GITHUB_API_TOKEN,
                            // },
                        }
                    )
                        // const fetchContributors = await
                        .then((res) => {
                            if (res.status === 200) {
                                return res.json()
                            } else {
                                return 'did not find contributors names'
                            }
                        })
                        .then((json) => {
                            for (let i = 0; i < json.length; i++) {
                                login.push(json[i].login)
                            }
                        })
                        .then(() => {
                            for (let j = 0; j < login.length; j++) {
                                promises.push(
                                    fetch(
                                        `https://api.github.com/users/${login[j]}`,
                                        {
                                            // headers: {
                                            //     Authorization:
                                            //         'token ' +
                                            //         process.env
                                            //             .GITHUB_API_TOKEN,
                                            // },
                                        }
                                    )
                                        .then((res) => res.json())
                                        .then((json) => {
                                            let object = {}
                                            object.name = json.name
                                            user.contributors.push(object)
                                        })
                                )
                            }
                            return Promise.all(promises).then(() => {
                                //console.log(user)
                                return user
                            })
                        })
                        .catch((error) => {
                            console.log(error)
                        }),
                ]).then(() => {
                    let c = []
                    document.getElementById('username').innerText = luck
                    document.getElementById('title').innerText = user.title
                    document.getElementById('description').innerText =
                        user.description
                    document.getElementById('commits').innerText = user.commits
                    for (let i = 0; i < user.contributors.length; i++) {
                        document.getElementById('contributors').innerHTML +=
                            user.contributors[i].name
                    }
                })
            }
        </script>
    </body>
</html>
